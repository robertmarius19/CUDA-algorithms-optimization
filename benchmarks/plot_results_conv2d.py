import pandas as pd
import matplotlib.pyplot as plt
import io
import sys
import os


FILE_NAME = "conv2d_results.csv"  
OUTPUT_IMG = "conv2d_benchmark.png"

def load_and_clean_data(filename):
    """
    Reads the CSV file while automatically ignoring the separator lines 
    generated by the bash script.
    """
    if not os.path.exists(filename):
        print(f"Error: The file '{filename}' was not found.")
        print("Make sure you run the benchmark script first.")
        sys.exit(1)

    try:
        cleaned_lines = []
        with open(filename, 'r') as f:
            for line in f:
                if not line.strip().startswith('-'):
                    cleaned_lines.append(line)

        df = pd.read_csv(io.StringIO(''.join(cleaned_lines)))
        
        df['N'] = pd.to_numeric(df['N'])
        df['time_ms'] = pd.to_numeric(df['time_ms'])
        
        return df
    except Exception as e:
        print(f"Error reading CSV: {e}")
        sys.exit(1)

def plot_conv(df):
    """
    Plots the Convolution benchmark results.
    """

    fig, ax = plt.subplots(figsize=(10, 7))
    

    subset = df[df['algo'] == 'CONV']
    
    styles = {
        'seq':  {'color': '#d62728', 'marker': 'o', 'label': 'Sequential (CPU)'},       # Red
        'omp':  {'color': '#1f77b4', 'marker': 's', 'label': 'OpenMP (Multi-core CPU)'}, # Blue
        'cuda': {'color': '#2ca02c', 'marker': '^', 'label': 'CUDA (GPU)'}               # Green
    }

    for version in ['seq', 'omp', 'cuda']:
        data = subset[subset['version'] == version].sort_values(by='N')
        
        if not data.empty:
            style = styles.get(version, {'color': 'black', 'marker': 'x', 'label': version})
            
            ax.plot(data['N'], data['time_ms'], 
                    marker=style['marker'], 
                    color=style['color'], 
                    label=style['label'],
                    linewidth=2.5,
                    markersize=8)

    ax.set_title("2D Convolution Performance (Lower is Better)", fontsize=16, fontweight='bold', pad=15)
    ax.set_xlabel("Image Size (N x N)", fontsize=13)
    ax.set_ylabel("Time (milliseconds)", fontsize=13)
    
    ax.set_xscale('log', base=2)
    ax.set_yscale('log')
    

    ax.grid(True, which="both", ls="--", alpha=0.4)
    
    ax.legend(fontsize=12, frameon=True, shadow=True)
    

    plt.tight_layout()
    

    plt.savefig(OUTPUT_IMG, dpi=150)
    print(f"Graph saved as '{OUTPUT_IMG}'")
    plt.show()

if __name__ == "__main__":

    df = load_and_clean_data(FILE_NAME)
    
    plot_conv(df)